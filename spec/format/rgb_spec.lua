local RGB = require 'color.format.rgb'
local spec_helper = require 'spec.spec_helper'

describe("to_rgb8", function()
  it("converts normalized RGB to 8-bit RGB", function()
    local r8, g8, b8 = RGB.to_rgb8(0.5, 0.25, 0.75)
    assert.equals(128, r8)
    assert.equals(64, g8)
    assert.equals(191, b8)
  end)

  it("handles boundary values", function()
    local r8, g8, b8 = RGB.to_rgb8(0.0, 1.0, 0.5)
    assert.equals(0, r8)
    assert.equals(255, g8)
    assert.equals(128, b8)
  end)

  it("clamps out-of-range values", function()
    local r8, g8, b8 = RGB.to_rgb8(-0.1, 1.5, 0.5)
    assert.equals(0, r8)
    assert.equals(255, g8)
    assert.equals(128, b8)
  end)
end)

describe("from_rgb8", function()
  it("converts 8-bit RGB to normalized RGB", function()
    local r, g, b = RGB.from_rgb8(128, 64, 191)
    spec_helper.assert_near(0.5019607843137255, r, 1e-10)
    spec_helper.assert_near(0.25098039215686274, g, 1e-10)
    spec_helper.assert_near(0.7490196078431373, b, 1e-10)
  end)

  it("handles boundary values", function()
    local r, g, b = RGB.from_rgb8(0, 255, 128)
    spec_helper.assert_near(0.0, r, 1e-10)
    spec_helper.assert_near(1.0, g, 1e-10)
    spec_helper.assert_near(0.5019607843137255, b, 1e-10)
  end)
end)

describe("to_hex24", function()
  it("converts normalized RGB to hex integer", function()
    local hex_int = RGB.to_hex24(0.5, 0.25, 0.75)
    assert.equals(0x8040BF, hex_int)
  end)

  it("handles boundary values", function()
    local hex_int = RGB.to_hex24(0.0, 1.0, 0.5)
    assert.equals(0x00FF80, hex_int)
  end)

  it("clamps out-of-range values", function()
    local hex_int = RGB.to_hex24(-0.1, 1.5, 0.5)
    assert.equals(0x00FF80, hex_int)
  end)
end)

describe("from_hex24", function()
  it("converts hex integer to normalized RGB", function()
    local r, g, b = RGB.from_hex24(0x8040BF)
    spec_helper.assert_near(0.5019607843137255, r, 1e-10)
    spec_helper.assert_near(0.25098039215686274, g, 1e-10)
    spec_helper.assert_near(0.7490196078431373, b, 1e-10)
  end)

  it("handles boundary values", function()
    local r, g, b = RGB.from_hex24(0x00FF80)
    spec_helper.assert_near(0.0, r, 1e-10)
    spec_helper.assert_near(1.0, g, 1e-10)
    spec_helper.assert_near(0.5019607843137255, b, 1e-10)
  end)

  it("rejects invalid hex values", function()
    assert.has_error(function() RGB.from_hex24(-1) end)
    assert.has_error(function() RGB.from_hex24(0x1000000) end)
  end)

  it("rejects invalid types", function()
    assert.has_error(function() RGB.from_hex24(nil) end)
    assert.has_error(function() RGB.from_hex24("8040BF") end)
  end)
end)

describe("clamp_rgb8", function()
  it("clamps RGB values to 8-bit range", function()
    local r8, g8, b8 = RGB.clamp_rgb8(128, 64, 191)
    assert.are.equal(128, r8)
    assert.are.equal(64, g8)
    assert.are.equal(191, b8)
  end)

  it("handles boundary values", function()
    local r8, g8, b8 = RGB.clamp_rgb8(0, 255, 128)
    assert.are.equal(0, r8)
    assert.are.equal(255, g8)
    assert.are.equal(128, b8)
  end)

  it("clamps out-of-range values", function()
    local r8, g8, b8 = RGB.clamp_rgb8(-10, 300, 128)
    assert.are.equal(0, r8)
    assert.are.equal(255, g8)
    assert.are.equal(128, b8)
  end)

  it("clamps fractional values to range", function()
    local r8, g8, b8 = RGB.clamp_rgb8(1.2, 2.7, 3.9)
    assert.are.equal(1.2, r8)
    assert.are.equal(2.7, g8)
    assert.are.equal(3.9, b8)
  end)
end)

describe("clamp_rgb", function()
  it("clamps RGB values to normalized range", function()
    local r, g, b = RGB.clamp_rgb(0.5, 0.25, 0.75)
    spec_helper.assert_near(0.5, r, 1e-10)
    spec_helper.assert_near(0.25, g, 1e-10)
    spec_helper.assert_near(0.75, b, 1e-10)
  end)

  it("handles boundary values", function()
    local r, g, b = RGB.clamp_rgb(0.0, 1.0, 0.5)
    spec_helper.assert_near(0.0, r, 1e-10)
    spec_helper.assert_near(1.0, g, 1e-10)
    spec_helper.assert_near(0.5, b, 1e-10)
  end)

  it("clamps out-of-range values", function()
    local r, g, b = RGB.clamp_rgb(-0.1, 1.5, 0.5)
    spec_helper.assert_near(0.0, r, 1e-10)
    spec_helper.assert_near(1.0, g, 1e-10)
    spec_helper.assert_near(0.5, b, 1e-10)
  end)
end)

describe("round_rgb", function()
  it("rounds RGB values to integers", function()
    local r, g, b = RGB.round_rgb(1.2, 2.7, 3.9)
    assert.are.equal(1, r)
    assert.are.equal(3, g)
    assert.are.equal(4, b)
  end)

  it("handles integer values", function()
    local r, g, b = RGB.round_rgb(5, 10, 15)
    assert.are.equal(5, r)
    assert.are.equal(10, g)
    assert.are.equal(15, b)
  end)

  it("rounds negative values", function()
    local r, g, b = RGB.round_rgb(-1.2, -2.7, -3.9)
    assert.are.equal(-1, r)
    assert.are.equal(-3, g)
    assert.are.equal(-4, b)
  end)
end)

describe("to_rgb100", function()
  it("converts 0.0 to 0% with tolerance", function()
    local r = RGB.to_rgb100(0.0, 0.0, 0.0)
    spec_helper.assert_near(0.0, r, 1e-10)
  end)

  it("converts 0.5 to 50% with tolerance", function()
    local r, g, b = RGB.to_rgb100(0.5, 0.5, 0.5)
    spec_helper.assert_near(50.0, r, 1e-10)
    spec_helper.assert_near(50.0, g, 1e-10)
    spec_helper.assert_near(50.0, b, 1e-10)
  end)

  it("converts 1.0 to 100% with tolerance", function()
    local r, g, b = RGB.to_rgb100(1.0, 1.0, 1.0)
    spec_helper.assert_near(100.0, r, 1e-10)
    spec_helper.assert_near(100.0, g, 1e-10)
    spec_helper.assert_near(100.0, b, 1e-10)
  end)

  it("converts three values with tolerance", function()
    local r, g, b = RGB.to_rgb100(0.5, 0.25, 0.75)
    spec_helper.assert_near(50.0, r, 1e-10)
    spec_helper.assert_near(25.0, g, 1e-10)
    spec_helper.assert_near(75.0, b, 1e-10)
  end)

  it("handles boundary 0.0", function()
    local r, g, b = RGB.to_rgb100(0.0, 0.0, 0.0)
    spec_helper.assert_near(0.0, r, 1e-10)
    spec_helper.assert_near(0.0, g, 1e-10)
    spec_helper.assert_near(0.0, b, 1e-10)
  end)

  it("handles boundary 1.0", function()
    local r, g, b = RGB.to_rgb100(1.0, 1.0, 1.0)
    spec_helper.assert_near(100.0, r, 1e-10)
    spec_helper.assert_near(100.0, g, 1e-10)
    spec_helper.assert_near(100.0, b, 1e-10)
  end)
end)

describe("from_rgb100", function()
  it("converts 0% to 0.0 with tolerance", function()
    local r, g, b = RGB.from_rgb100(0.0, 0.0, 0.0)
    spec_helper.assert_near(0.0, r, 1e-10)
    spec_helper.assert_near(0.0, g, 1e-10)
    spec_helper.assert_near(0.0, b, 1e-10)
  end)

  it("converts 50% to 0.5 with tolerance", function()
    local r, g, b = RGB.from_rgb100(50.0, 50.0, 50.0)
    spec_helper.assert_near(0.5, r, 1e-10)
    spec_helper.assert_near(0.5, g, 1e-10)
    spec_helper.assert_near(0.5, b, 1e-10)
  end)

  it("converts 100% to 1.0 with tolerance", function()
    local r, g, b = RGB.from_rgb100(100.0, 100.0, 100.0)
    spec_helper.assert_near(1.0, r, 1e-10)
    spec_helper.assert_near(1.0, g, 1e-10)
    spec_helper.assert_near(1.0, b, 1e-10)
  end)

  it("converts three values with tolerance", function()
    local r, g, b = RGB.from_rgb100(50.0, 25.0, 75.0)
    spec_helper.assert_near(0.5, r, 1e-10)
    spec_helper.assert_near(0.25, g, 1e-10)
    spec_helper.assert_near(0.75, b, 1e-10)
  end)

  it("handles boundary 0%", function()
    local r, g, b = RGB.from_rgb100(0.0, 0.0, 0.0)
    spec_helper.assert_near(0.0, r, 1e-10)
    spec_helper.assert_near(0.0, g, 1e-10)
    spec_helper.assert_near(0.0, b, 1e-10)
  end)

  it("handles boundary 100%", function()
    local r, g, b = RGB.from_rgb100(100.0, 100.0, 100.0)
    spec_helper.assert_near(1.0, r, 1e-10)
    spec_helper.assert_near(1.0, g, 1e-10)
    spec_helper.assert_near(1.0, b, 1e-10)
  end)
end)