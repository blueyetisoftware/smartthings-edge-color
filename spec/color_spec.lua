local Color = require 'color'

describe("Color module", function()
  describe("cct_to_rgb conversions", function()
    it("converts 3000K to correct RGB", function()
      local r, g, b = Color.to_8bit(Color.cct_to_rgb(3000))
      assert.are.equal(255, r)
      assert.are.equal(180, g)
      assert.are.equal(108, b)
    end)

    it("converts 10000K to correct RGB", function()
      local r, g, b = Color.to_8bit(Color.cct_to_rgb(10000))
      assert.are.equal(204, r)
      assert.are.equal(220, g)
      assert.are.equal(255, b)
    end)

    it("converts 1500K to correct RGB", function()
      local r, g, b = Color.to_8bit(Color.cct_to_rgb(1500))
      assert.are.equal(255, r)
      assert.are.equal(107, g)
      assert.are.equal(0, b)
    end)
  end)

  describe("rgb_to_cct conversions", function()
    it("converts RGB (255,180,108) back to approx 3000K", function()
      local cct = Color.rgb_to_cct(255, 180, 108)
      assert.is_true(math.abs(cct - 3000) <= 500)
    end)

    it("converts RGB (204,220,255) back to approx 10000K", function()
      local cct = Color.rgb_to_cct(204, 220, 255)
      assert.is_true(math.abs(cct - 10000) <= 500)
    end)

    it("converts RGB (255,107,0) back to approx 1500K", function()
      local cct = Color.rgb_to_cct(255, 107, 0)
      assert.is_true(math.abs(cct - 1500) <= 500)
    end)
  end)

  describe("other conversions", function()
    it("converts rgb to cct", function()
      local cct = Color.rgb_to_cct(204, 220, 255)
      assert.are.equal(9985, cct)
    end)

    it("converts hsv to xy", function()
      local x, y, Y = Color.hsv_to_xy(50, 50)
      assert.is_true(math.abs(x - 0.28552972694502) < 1e-10)
      assert.is_true(math.abs(y - 0.90810373061023) < 1e-10)
      assert.is_true(math.abs(Y - (-2.4274166356037)) < 1e-10)
    end)

    it("converts xy to hsv", function()
      local h, s, v = Color.xy_to_hsv(16206, 21550)
      assert.is_true(math.abs(h - 0.16666666666667) < 1e-10)
      assert.are.equal(1.0, s)
      assert.are.equal(1.0, v)
    end)

    it("converts xy to cct", function()
      local cct = Color.xy_to_cct(50, 100)
      assert.are.equal(1000, cct)
    end)

    it("converts cct to rgb and then to 8bit", function()
      local r, g, b = Color.to_8bit(Color.cct_to_rgb(3000))
      assert.are.equal(255, r)
      assert.are.equal(180, g)
      assert.are.equal(108, b)
    end)
  end)
end)